# Relay Server

Node.js server that wraps pi sessions and exposes REST API + WebSocket for remote clients.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Relay Server                           │
├─────────────────────────────────────────────────────────────┤
│  REST API (/api/*)           │  WebSocket (/ws/*)           │
│  - Sessions CRUD             │  - RPC message proxy         │
│  - Environments CRUD         │  - Transparent passthrough   │
│  - GitHub repos              │  - No protocol modification  │
│  - Secrets management        │                              │
├─────────────────────────────────────────────────────────────┤
│                    Sandbox Manager                          │
│  - Docker provider (creates containers with pi)             │
│  - Manages pi process lifecycle                             │
│  - Routes stdin/stdout ↔ WebSocket                          │
└─────────────────────────────────────────────────────────────┘
```

## Two Communication Layers

### REST API (Custom, Extendable)

Location: `src/routes/`

The REST API is our custom infrastructure for managing resources. Add new endpoints freely.

**Current endpoints:**
- `/api/sessions` - Session lifecycle
- `/api/environments` - Environment configuration
- `/api/github/*` - GitHub integration
- `/api/secrets` - Provider API keys
- `/api/models` - Available AI models

**Adding a new endpoint:**
1. Create route file in `src/routes/`
2. Create service in `src/services/` if needed
3. Add types (request/response interfaces)
4. Wire up in `src/app.ts`
5. Update `packages/pi-core/Sources/PiCore/Relay/` with Swift types

### WebSocket (RPC Proxy, DO NOT MODIFY)

Location: `src/ws/handler.ts`

The WebSocket handler is a **transparent proxy** for RPC messages between the client and the pi agent running in a sandbox.

**Rules:**
- DO NOT add new message types to the WebSocket protocol
- DO NOT transform or enrich RPC messages
- DO NOT wrap RPC messages in additional envelopes
- The WebSocket just forwards JSON between client and pi's stdin/stdout

**What the WebSocket does:**
```
Client → WebSocket → pi stdin (JSON command)
pi stdout → WebSocket → Client (JSON event)
```

**What the WebSocket does NOT do:**
- Define its own protocol
- Add metadata to RPC messages
- Filter or modify events
- Maintain protocol-level state

If you need to add relay-specific communication (not agent communication), use REST endpoints or a separate WebSocket namespace - never modify the RPC proxy.

## Directory Structure

```
src/
├── routes/           # REST API endpoints
│   ├── sessions.ts
│   ├── environments.ts
│   ├── github.ts
│   └── ...
├── services/         # Business logic
│   ├── session.service.ts
│   ├── environment.service.ts
│   └── ...
├── sandbox/          # Sandbox providers
│   ├── types.ts      # SandboxHandle interface
│   ├── manager.ts    # Provider orchestration
│   └── docker.ts     # Docker implementation
├── ws/               # WebSocket handling
│   └── handler.ts    # RPC proxy (DO NOT ADD PROTOCOL)
├── db/               # Database
│   ├── schema.ts     # Drizzle schema
│   ├── connection.ts
│   └── migrations/
├── app.ts            # Hono app factory
├── config.ts         # Configuration
└── index.ts          # Entry point
```

## Database

Uses SQLite with Drizzle ORM.

**Schema location:** `src/db/schema.ts`

**Generating migrations:**
```bash
pnpm --filter pi-relay-server db:generate
```

**Running migrations:**
```bash
pnpm --filter pi-relay-server db:migrate
```

Migrations are auto-generated by drizzle-kit. Do not write SQL migration files manually.

## Response Format

All REST endpoints use consistent response format:

```typescript
interface RelayResponse<T> {
  data: T | null;
  error: string | null;
}
```

Success: `{ data: <result>, error: null }`
Error: `{ data: null, error: "<message>" }`

## Service Pattern

Services encapsulate database operations and business logic:

```typescript
export class SomeService {
  constructor(private db: AppDatabase) {}
  
  create(params: CreateParams): Record { ... }
  get(id: string): Record | undefined { ... }
  list(): Record[] { ... }
  update(id: string, params: UpdateParams): void { ... }
  delete(id: string): void { ... }
}
```

Services are injected via Hono context middleware in `app.ts`.

## Adding a New Feature

Example: Adding a new resource "widgets"

1. **Schema** (`src/db/schema.ts`):
   ```typescript
   export const widgets = sqliteTable("widgets", {
     id: text("id").primaryKey(),
     name: text("name").notNull(),
     // ...
   });
   ```

2. **Generate migration**:
   ```bash
   pnpm --filter pi-relay-server db:generate
   ```

3. **Service** (`src/services/widget.service.ts`):
   ```typescript
   export class WidgetService {
     constructor(private db: AppDatabase) {}
     // CRUD methods
   }
   ```

4. **Routes** (`src/routes/widgets.ts`):
   ```typescript
   export function widgetsRoutes(): Hono<AppEnv> {
     const app = new Hono<AppEnv>();
     app.get("/", (c) => { ... });
     app.post("/", (c) => { ... });
     return app;
   }
   ```

5. **Wire up** (`src/app.ts`):
   - Add to `AppEnv.Variables`
   - Add to `AppServices`
   - Inject in middleware
   - Mount route

6. **Swift types** (`packages/pi-core/Sources/PiCore/Relay/`):
   - Add `Widget` type to `RelayTypes.swift`
   - Add API methods to `RelayAPIClient.swift`

## Environment Variables

See `src/env.ts` for required/optional environment variables.

Key variables:
- `PORT` - Server port (default: 31415)
- `DATABASE_URL` - SQLite path
- `GITHUB_TOKEN` - For repo access
- Provider keys (`ANTHROPIC_API_KEY`, `OPENAI_API_KEY`, etc.)
