# Production deployment: relay + dashboard
#
# Usage:
#   RELAY_ENCRYPTION_KEY=$(openssl rand -base64 32) docker compose up -d
#
# Dashboard is served at :8080, relay API at :31415.
# Dashboard proxies API requests to relay internally.

services:
  relay:
    build: server/relay
    image: ghcr.io/aliou/pi-relay
    ports:
      - "31415:31415"
    volumes:
      # Docker socket for managing sandbox containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Bind mounts with identical host/container paths. The relay passes
      # these paths to Docker when creating sandbox containers, and Docker
      # resolves them on the host. They must match on both sides.
      - /opt/pi-relay/data:/opt/pi-relay/data
      - /opt/pi-relay/config:/opt/pi-relay/config
      - /opt/pi-relay/state:/opt/pi-relay/state
      - /opt/pi-relay/cache:/opt/pi-relay/cache
    environment:
      PI_RELAY_DATA_DIR: /opt/pi-relay/data
      PI_RELAY_CONFIG_DIR: /opt/pi-relay/config
      PI_RELAY_STATE_DIR: /opt/pi-relay/state
      PI_RELAY_CACHE_DIR: /opt/pi-relay/cache
      RELAY_ENCRYPTION_KEY: ${RELAY_ENCRYPTION_KEY}
    restart: unless-stopped

  dashboard:
    build: clients/dashboard
    image: ghcr.io/aliou/pi-dashboard
    ports:
      - "8080:8080"
    environment:
      RELAY_URL: http://relay:31415
    depends_on:
      - relay
    restart: unless-stopped
