name: Vendor Documentation

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "pi release tag (leave empty for latest)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  vendor-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pi-apps
        uses: actions/checkout@v4

      - name: Resolve release tag
        id: release
        run: |
          TAG="${{ inputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG=$(curl -sf https://api.github.com/repos/badlogic/pi-mono/releases/latest | jq -r .tag_name)
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Resolved release tag: $TAG"

      - name: Vendor documentation
        run: |
          set -euo pipefail

          TAG="${{ steps.release.outputs.tag }}"
          URL="https://github.com/badlogic/pi-mono/releases/download/${TAG}/pi-linux-x64.tar.gz"
          DEST=docs/vendor/pi-coding-agent

          rm -rf "$DEST"
          mkdir -p "$DEST"

          # Extract only the markdown docs from the release tarball
          curl -sfL "$URL" | tar xz -C "$DEST" --strip-components=2 'pi/docs/'

          # Remove non-markdown content (images, example subdirs)
          find "$DEST" -mindepth 1 -type d -exec rm -rf {} + 2>/dev/null || true

          # Record provenance
          cat > "$DEST/.vendored" <<EOF
          source: badlogic/pi-mono
          release: ${TAG}
          vendored_at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF

      - name: Check for changes
        id: diff
        run: |
          git add docs/vendor
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.diff.outputs.changed == 'true'
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "docs: vendor pi-coding-agent docs from pi ${TAG}"
          git push
